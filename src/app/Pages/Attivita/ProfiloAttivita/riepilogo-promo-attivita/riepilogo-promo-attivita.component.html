<ion-spinner *ngIf="isLoading" name="crescent" color="primary"></ion-spinner>

<!-- SELEZIONE ATTIVITÀ -->
<div class="contentListAtt" *ngIf="!isLoading && listaAttivita && !isModifica">
  <ion-toolbar class="ModalToolbarAddAtt">
    <ion-title >{{ 'SELECT_ACTIVITY' | translate }}</ion-title>
  </ion-toolbar>
  <ion-card *ngFor="let att of listaAttivita" (click)="getPromoAttivita(att.idAttivita)" class="activity-card">
    <ion-grid>
      <ion-row>
        <ion-col size="10">
          <ion-card-header>
            <ion-card-title class="att-title">{{ att.nome }}</ion-card-title>
            <ion-card-subtitle class="att-subtitle">
              {{ att.citta }}, {{ att.indirizzo }}, {{ att.civico }}, {{ att.cap }}
            </ion-card-subtitle>
          </ion-card-header>
        </ion-col>
        <ion-col size="2" class="att-icon-col">
          <ion-icon name="create-outline"></ion-icon>
        </ion-col>
      </ion-row>
    </ion-grid>
  </ion-card>
</div>

<!-- LISTA PROMO -->
<div *ngIf="!isLoading && !isModifica && !listaAttivita" class="full-width-container">
  <ion-segment [(ngModel)]="segmentValue" (ionChange)="onSegmentChange($event)" class="my-segment">
    <ion-segment-button value="default" class="my-button-left">
      <ion-label>{{ 'ACTIVE_PROMOS' | translate }}</ion-label>
    </ion-segment-button>
    <ion-segment-button value="segment" class="my-button-right">
      <ion-label>{{ 'INACTIVE_PROMOS' | translate }}</ion-label>
    </ion-segment-button>
  </ion-segment>

  <!-- PROMO ATTIVE -->
  <ng-container *ngIf="segmentValue === 'default'">
    <div *ngIf="listaPromoAttive?.length === 0" class="lblAdd ion-text-center" style="margin-top: 30vh;">
      <ion-label>{{ 'NO_ACTIVE_PROMOS' | translate }}</ion-label>
      <ion-button expand="block" style="margin-top: 16px;" (click)="openPage()">{{ 'ADD_PROMO' | translate }}</ion-button>
    </div>

    <ion-accordion-group *ngIf="(listaPromoAttive?.length ?? 0) > 0" style="margin-top: 10px;">
      <ion-accordion *ngFor="let promo of listaPromoAttive">
        <ion-item slot="header" color="light">
          <ion-label class="ion-text-wrap">
            <div style="display: flex; flex-direction: column;">
              <span class="scadenza-label">Scadenza: {{ promo.dataAl | date:'dd-MM-yyyy' }}</span>
              <span class="titlePromo" style="margin-top: 6px;">{{ promo.titoloPromo }}</span>
            </div>
          </ion-label>
        </ion-item>

        <div class="ion-padding" slot="content">
          <ion-list lines="none">
            <ion-item>
              <ion-label><strong>{{ 'DESCRIPTION' | translate }}</strong>: {{ promo.descPromo }}</ion-label>
            </ion-item>
            <ion-item>
              <ion-label><strong>{{ 'VALIDITY_PERIOD' | translate }}</strong>: {{ promo.dataDal | date:'dd-MM-yyyy' }} - {{ promo.dataAl | date:'dd-MM-yyyy' }}</ion-label>
            </ion-item>
            <ion-item>
              <ion-label><strong>{{ 'ON_DAYS' | translate }}</strong>:</ion-label>
              <ion-chip *ngFor="let d of promo.days">{{ ('DAY_' + d) | translate }}</ion-chip>
            </ion-item>
            <ion-item>
              <ion-label><strong>{{ 'TIME' | translate }}</strong>: 
                <ng-container *ngIf="promo.isAllDayValidita">{{ 'ALL_DAY' | translate }}</ng-container>
                <ng-container *ngIf="!promo.isAllDayValidita">{{ 'FROM' | translate }} {{ promo.orarioValiditaDa }} - {{ 'TO' | translate }} {{ promo.orarioValiditaAl }}</ng-container>
              </ion-label>
            </ion-item>
            <ion-item>
              <ion-label><strong>{{ 'MAX_COUPONS' | translate }}</strong>: {{ promo.numCouponMax || ('NO_LIMIT' | translate) }}</ion-label>
            </ion-item>
            <ion-item>
              <ion-label><strong>{{ 'COUPONS_PER_PERSON' | translate }}</strong>: {{ promo.numUtilizziPerPersonaMax || ('NO_LIMIT' | translate) }}</ion-label>
            </ion-item>
            <ion-item>
              <ion-chip *ngFor="let tipo of promo.listaTipologie">{{ tipo.descrizione }}</ion-chip>
            </ion-item>
            <ion-item>
              <ion-grid>
                <ion-row>
                  <ion-col><strong>{{ 'COUPONS_REQUESTED_COUNT' | translate }}</strong></ion-col>
                  <ion-col>{{ promo.numCouponRichiesti || 0 }}</ion-col>
                </ion-row>
                <ion-row>
                  <ion-col><strong>{{ 'COUPONS_USED' | translate }}</strong></ion-col>
                  <ion-col>{{ promo.numCouponUtilizzati || 0 }}</ion-col>
                </ion-row>
                <ion-row>
                  <ion-col><strong>{{ 'COUPONS_REMAINING' | translate }}</strong></ion-col>
                  <ion-col *ngIf="!promo.numCouponRimanenti">{{ 'UNLIMITED' | translate }}</ion-col>
                  <ion-col *ngIf="promo.numCouponRimanenti">{{promo.numCouponRimanenti}}</ion-col>
                </ion-row>
              </ion-grid>
            </ion-item>
          </ion-list>

          <div class="ion-text-center" style="margin-top: 1rem;">
            <ion-button shape="round" (click)="ModificaPromo(promo)">{{ 'EDIT' | translate }}</ion-button>
            <ion-button shape="round" color="warning" (click)="openDisattivaPromo(promo.idPromo, promo.idAttivita, promo.numCouponRichiesti)">{{ 'DISABLE' | translate }}</ion-button>
          </div>
        </div>
      </ion-accordion>
    </ion-accordion-group>
  </ng-container>

  <!-- PROMO NON ATTIVE -->
  <ng-container *ngIf="segmentValue === 'segment'">
    <ion-accordion-group *ngIf="(listaPromoNonAttive?.length ?? 0) > 0" style="margin-top: 10px;">
      <ion-accordion *ngFor="let promo of listaPromoNonAttive">
        <ion-item slot="header" color="light">
          <ion-label>
            <div class="title2">{{ promo.titoloPromo }}</div>
            <div>{{ promo.dataInserimento | date:'dd-MM-yyyy' }}</div>
          </ion-label>
        </ion-item>

        <div class="ion-padding" slot="content">
          <ion-list lines="none">
            <ion-item>
              <ion-label><strong>{{ 'DESCRIPTION' | translate }}</strong>: {{ promo.descPromo }}</ion-label>
            </ion-item>
            <ion-item>
              <ion-label><strong>{{ 'VALIDITY_PERIOD' | translate }}</strong>: {{ promo.dataDal | date:'dd-MM-yyyy' }} → {{ promo.dataAl | date:'dd-MM-yyyy' }}</ion-label>
            </ion-item>
            <ion-item>
              <ion-label><strong>{{ 'ON_DAYS' | translate }}</strong>:</ion-label>
              <ion-chip *ngFor="let d of promo.days">{{ ('DAY_' + d) | translate }}</ion-chip>
            </ion-item>
            <ion-item>
              <ion-label><strong>{{ 'TIME' | translate }}</strong>: 
                <ng-container *ngIf="promo.isAllDayValidita">{{ 'ALL_DAY' | translate }}</ng-container>
                <ng-container *ngIf="!promo.isAllDayValidita">{{ 'FROM' | translate }} {{ promo.orarioValiditaDa }} - {{ 'TO' | translate }} {{ promo.orarioValiditaAl }}</ng-container>
              </ion-label>
            </ion-item>
            <ion-item>
              <ion-chip *ngFor="let tipo of promo.listaTipologie">{{ tipo.descrizione }}</ion-chip>
            </ion-item>
            <ion-item>
              <ion-label><strong>{{ 'MAX_COUPONS' | translate }}</strong>: {{ promo.numCouponMax || ('NO_LIMIT' | translate) }}</ion-label>
            </ion-item>
            <ion-item>
              <ion-label><strong>{{ 'COUPONS_PER_PERSON' | translate }}</strong>: {{ promo.numUtilizziPerPersonaMax || ('NO_LIMIT' | translate) }}</ion-label>
            </ion-item>
          </ion-list>
          <div class="ion-text-center" style="margin-top: 1rem;">
            <ion-button shape="round" color="success" (click)="ModificaPromo(promo)">{{ 'REACTIVATE' | translate }}</ion-button>
          </div>
        </div>
      </ion-accordion>
    </ion-accordion-group>
  </ng-container>
</div>

<!-- MODAL AGGIUNTA/MODIFICA -->
<ion-modal [isOpen]="isModifica" (didDismiss)="recoverModificaPromo()" class="full-modal" [breakpoints]="[0.25, 0.5, 1]" [initialBreakpoint]="1">

  <ng-template>
    <app-form-promo [idAttivita]="idAttivita" 
                    [modificaPromo]="promoSelezionata" 
                    (closeModal)="recoverModificaPromo()"
                    (closeModalAndRefresh)="recoverModificaPromoRefresh()"
                    (closeModalAndGoToPage)="onModalDismissAndGoToPage($event)"></app-form-promo>
  </ng-template>
</ion-modal>

<!-- MODAL CONFERMA DISATTIVAZIONE -->
<ion-modal [isOpen]="isConfirmOpen" class="full-modal">
  <ng-template>
    <app-conferma-disattivazione-promo
      [idPromo]="idPromoDisable"
      [idAttivita]="idAttivitaDisable"
      [couponRichiesti]="numCouponRichiesti"
      (dismissDisattivazioneEvent)="dismissDisattivaPromo($event)">
    </app-conferma-disattivazione-promo>
  </ng-template>
</ion-modal>


